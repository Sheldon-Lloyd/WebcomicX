@using System.Xml.Linq
@using System.Xml
@using System.IO;

@{
    if (IsPost) {
        var index = Request["index"].AsInt();
        var currentIndex = Request["current"].AsInt();
        var position = Request["position"];
        var id = Request["id"];

        //load xml file
        var widgetsXml = "/App_Data/widgets.xml";
        var load = new Comic();
        var widgets = load.LoadComic(widgetsXml);

        //get widget
        var widget = (from xml in widgets.Descendants("Container")
                      where xml.Element("Id").Value == id
                      select xml).FirstOrDefault();

        //get the position of the parent of the widget to get its position
        var oldPosition = widget.Parent.Name;


        if (currentIndex>=index) {//if the old index is greater than or equal to the new element index 
                                  //the widget will be removed before being added before the indicated widget index
            widget.Remove();
            widgets.Descendants(position).Descendants("Container").ElementAt(index).AddBeforeSelf(widget);
        }else {//the widget will be removed after adding the wudget after the indicated widget index
            widgets.Descendants(position).Descendants("Container").ElementAt(index).AddAfterSelf(widget);
            widget.Remove();

        }

        widgets.Save(Server.MapPath(widgetsXml));

    }
}
